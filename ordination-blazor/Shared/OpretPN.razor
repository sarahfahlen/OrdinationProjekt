@namespace ordinationsapp.Shared

@using shared.Model;
@using ordinationsapp.Model;
@using ordinationsapp.Data;
@inject ApiService apiService

<div class="pn-wrapper">

    <h1 class="pn-title">Opret ordination (PN)</h1>

    <div class="pn-card">

        <div class="pn-section">
            <div class="pn-section-title">Patientoplysninger</div>
            <div class="pn-patient-line">
                <strong>@Patient?.navn</strong> - @Patient?.cprnr
            </div>
        </div>

        <div class="pn-section">
            <div class="pn-section-title">Ordinationsoplysninger</div>

            <div class="pn-grid">

                <div class="pn-field">
                    <label>Lægemiddel</label>
                    <input readonly type="text" value="@laegemiddel?.navn" />
                </div>

                <div class="pn-daterange">
                    <div class="pn-field">
                        <label>Startdato</label>
                        <input @bind="StartDato" type="date" />
                    </div>

                    <div class="pn-field">
                        <label>Slutdato</label>
                        <input @bind="SlutDato" type="date" />
                    </div>
                </div>


                <div class="pn-field">
                    <label>Anbefalet døgn-dosis</label>
                    <input readonly type="text" value="@AnbefaletDosisPerDøgnRounded" />
                </div>

                <div class="pn-field">
                    <label>Antal enheder (styk)</label>
                    <input type="number" @bind="antalEnheder" />
                </div>

            </div>
        </div>

        <div class="pn-buttons">
            <button class="pn-btn-primary" @onclick="Opret">Opret ordination</button>
            <button class="pn-btn-secondary" @onclick="() => onFortryd?.Invoke()">Fortryd</button>
        </div>

    </div>

</div>


@code {
    [Parameter] public PatientResponse? Patient { get; set; }
    [Parameter] public Laegemiddel? laegemiddel { get; set; }
    [Parameter] public double AnbefaletDosisPerDøgn { get; set; }
    public string AnbefaletDosisPerDøgnRounded => AnbefaletDosisPerDøgn.ToString("#.##");

    [Parameter] public Action? onFortryd { get; set; }
    [Parameter] public Action<string>? onDone { get; set; }

    private int antalEnheder = 0;
    private DateTime StartDato { get; set; } = DateTime.Now;
    private DateTime SlutDato { get; set; } = DateTime.Now.AddDays(3);

    private async void Opret()
    {
        if (Patient == null || laegemiddel == null) return;

        PN pn = await apiService.OpretPN(Patient.id, laegemiddel.LaegemiddelId, antalEnheder, StartDato, SlutDato);
        onDone?.Invoke($"Oprettet PN ordination for {Patient.navn}!");
    }
}
