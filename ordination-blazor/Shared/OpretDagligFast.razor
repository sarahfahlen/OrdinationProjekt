@namespace ordinationsapp.Shared

@using shared.Model
@using ordinationsapp.Model
@using ordinationsapp.Data
@inject ApiService apiService

<div class="fast-wrapper">

    <h1 class="fast-title">Opret ordination (Daglig fast)</h1>

    <div class="fast-card">

        <!-- Patient -->
        <div class="fast-section">
            <div class="fast-section-title">Patientoplysninger</div>

            <div class="fast-patient-line">
                <strong>@Patient?.navn</strong> - @Patient?.cprnr
            </div>
        </div>

        <!-- Ordinationsoplysninger -->
        <div class="fast-section">
            <div class="fast-section-title">Ordinationsoplysninger</div>

            <div class="fast-grid-3">
                <div class="fast-field">
                    <label>Lægemiddel</label>
                    <input readonly type="text" value="@laegemiddel?.navn" />
                </div>

                <div class="fast-field">
                    <label>Startdato</label>
                    <input type="date" @bind="StartDato" />
                </div>

                <div class="fast-field">
                    <label>Slutdato</label>
                    <input type="date" @bind="SlutDato" />
                </div>
            </div>

            <div class="fast-field">
                <label>Anbefalet antal enheder pr. døgn</label>
                <input readonly value="@AnbefaletDosisPerDøgnRounded" />
            </div>
        </div>

        <!-- Doser -->
        <div class="fast-section">
            <div class="fast-section-title">Døgnfordeling af doser</div>

            <div class="fast-grid-4">

                <div class="fast-field">
                    <label>Antal morgen</label>
                    <input type="number" @bind="antalMorgen" />
                </div>

                <div class="fast-field">
                    <label>Antal middag</label>
                    <input type="number" @bind="antalMiddag" />
                </div>

                <div class="fast-field">
                    <label>Antal aften</label>
                    <input type="number" @bind="antalAften" />
                </div>

                <div class="fast-field">
                    <label>Antal nat</label>
                    <input type="number" @bind="antalNat" />
                </div>
            </div>
        </div>

        <!-- Knapper -->
        <div class="fast-buttons">
            <button class="fast-btn-primary" @onclick="Opret">Opret ordination</button>
            <button class="fast-btn-secondary" @onclick="() => onFortryd?.Invoke()">Fortryd</button>
        </div>

    </div>
</div>

@code {
    [Parameter] public PatientResponse? Patient { get; set; }
    [Parameter] public Laegemiddel? laegemiddel { get; set; }
    [Parameter] public double AnbefaletDosisPerDøgn { get; set; }
    public string AnbefaletDosisPerDøgnRounded => AnbefaletDosisPerDøgn.ToString("#.##");
    [Parameter] public Action? onFortryd { get; set; }
    [Parameter] public Action<string>? onDone { get; set; }

    private int antalMorgen = 0;
    private int antalMiddag = 0;
    private int antalAften = 0;
    private int antalNat = 0;
    private DateTime StartDato { get; set; } = DateTime.Now;
    private DateTime SlutDato { get; set; } = DateTime.Now.AddDays(3);

    private async void Opret() {
        if (Patient == null || laegemiddel == null) return;

        await apiService.OpretDagligFast(
            Patient.id,
            laegemiddel.LaegemiddelId,
            antalMorgen, antalMiddag, antalAften, antalNat,
            StartDato, SlutDato
        );

        onDone?.Invoke($"Oprettet Daglig Fast ordination for {Patient.navn}!");
    }
}
