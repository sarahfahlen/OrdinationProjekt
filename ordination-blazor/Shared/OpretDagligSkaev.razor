@namespace ordinationsapp.Shared

@using shared.Model
@using shared
@using ordinationsapp.Model
@using ordinationsapp.Data
@inject ApiService apiService

<div class="skaev-wrapper">

    <h1 class="skaev-title">Opret ordination (Daglig skæv)</h1>

    @if (!string.IsNullOrEmpty(Fejlbesked))
    {
        <div class="skaev-error">@Fejlbesked</div>
    }

    <div class="skaev-card">

        <!-- Patient sektion -->
        <div class="skaev-section">
            <div class="skaev-section-title">Patientoplysninger</div>
            <div class="skaev-patient-line">
                <strong>@Patient?.navn</strong> - @Patient?.cprnr
            </div>
        </div>

        <!-- Ordination sektion -->
        <!-- Ordination sektion -->
        <div class="skaev-section">
            <div class="skaev-section-title">Ordinationsoplysninger</div>

            <div class="skaev-grid-3">
                <div class="skaev-field">
                    <label>Lægemiddel</label>
                    <input readonly type="text" value="@laegemiddel?.navn" />
                </div>

                <div class="skaev-field">
                    <label>Startdato</label>
                    <input @bind="StartDato" type="date" />
                </div>

                <div class="skaev-field">
                    <label>Slutdato</label>
                    <input @bind="SlutDato" type="date" />
                </div>
            </div>


            <div class="skaev-field">
                <label>Anbefalet døgn-dosis</label>
                <input readonly type="text" value="@AnbefaletDosisPerDøgnRounded" />
            </div>
        </div>

        <!-- Doserings sektion -->
        <div class="skaev-section">
            <div class="skaev-section-title">Tilføj doser</div>

            <div class="skaev-dose-row">

                <div class="skaev-field">
                    <label>Tidspunkt</label>
                    <input @bind="Tid" type="time" />
                </div>

                <div class="skaev-field">
                    <label>Mængde</label>
                    <input @bind="Antal" type="number" step="0.01" />
                </div>

                <div class="skaev-dose-btn-wrapper">
                    <button class="skaev-dose-btn" @onclick="OpretDosis">Tilføj dosis</button>
                </div>

            </div>


            <ul class="skaev-dose-list">
                @foreach (var dosis in doser)
                {
                    <li class="skaev-dose-item">
                        <span class="skaev-dose-time">@dosis.tid.ToString("HH:mm")</span>
                        <span class="skaev-dose-separator">|</span>
                        <span class="skaev-dose-amount">@dosis.antal</span>
                    </li>


                }
            </ul>
        </div>

        <!-- Knapper -->
        <div class="skaev-buttons">
            <button class="skaev-btn-primary" @onclick="Opret">Opret ordination</button>
            <button class="skaev-btn-secondary" @onclick="() => onFortryd?.Invoke()">Fortryd</button>
        </div>

    </div>

</div>

@code {
    [Parameter] public PatientResponse? Patient { get; set; }
    [Parameter] public Laegemiddel? laegemiddel { get; set; }
    [Parameter] public double AnbefaletDosisPerDøgn { get; set; }
    [Parameter] public Action? onFortryd { get; set; }
    [Parameter] public Action<string>? onDone { get; set; }

    public string AnbefaletDosisPerDøgnRounded => AnbefaletDosisPerDøgn.ToString("0.##");

    private DateTime StartDato { get; set; } = DateTime.Now.Date;
    private DateTime SlutDato { get; set; } = DateTime.Now.Date.AddDays(3);

    private List<Dosis> doser = new();
    private string? Fejlbesked;

    private TimeOnly Tid { get; set; }
    private double Antal { get; set; }

    private async Task Opret()
    {
        Fejlbesked = null;

        if (Patient == null || laegemiddel == null)
            return;

        if (doser.Count == 0)
        {
            Fejlbesked = "Fejl: Du skal tilføje mindst én dosis.";
            return;
        }

        try
        {
            await apiService.OpretDagligSkaev(
                Patient.id,
                laegemiddel.LaegemiddelId,
                doser.ToArray(),
                StartDato,
                SlutDato
            );

            onDone?.Invoke($"Oprettet Daglig Skæv for {Patient.navn}!");
        }
        catch (Exception ex)
        {
            Fejlbesked = ex.Message;
        }
    }

    private void OpretDosis()
    {
        Fejlbesked = null;

        if (Antal <= 0)
        {
            Fejlbesked = "Fejl: Antal skal være større end 0.";
            return;
        }

        double sum = doser.Sum(d => d.antal) + Antal;

        if (sum > AnbefaletDosisPerDøgn)
        {
            Fejlbesked = $"Fejl: Den samlede dosis ({sum:F2}) overstiger den anbefalede ({AnbefaletDosisPerDøgn:F2}).";
            return;
        }

        doser.Add(new Dosis(Util.CreateTimeOnly(Tid), Antal));
    }
}
