@page "/Vis"

@using ordinationsapp.Data;
@using shared.Model;
@using ordinationsapp.Shared
@using ordinationsapp.Model;
@inject ApiService apiService

<div class="vis-wrapper">

    <h1 class="vis-title">Vis ordinationer</h1>

    <div class="vis-grid">

        <!-- Patient Liste -->
        <div class="vis-card">
            <h3 class="vis-card-title">Vælg patient</h3>
            <PatientList onSelectPatient="@onSelectPatient" patienter="@patienter"></PatientList>
        </div>

        <!-- Ordination Liste -->
        <div class="vis-card">
            <h3 class="vis-card-title">Vælg ordination</h3>
            <OrdinationList onSelectOrdination="@onSelectOrdination" ordinationer="@ordinationer"></OrdinationList>
        </div>

        <!-- Ordination detaljer -->
        <div class="vis-card vis-card-details">
            @if (ordination != null && ordination.getType().Equals("PN")) {
                <PNDetails pn="@( (PN)ordination )"></PNDetails>
            }
            else if (ordination != null && ordination.getType().Equals("DagligSkæv")) {
                <SkævDetails skæv="@( (DagligSkæv)ordination )"></SkævDetails>
            }
            else if (ordination != null && ordination.getType().Equals("DagligFast")) {
                <FastDetails fast="@( (DagligFast)ordination )"></FastDetails>
            }
            else
            {
                <div class="vis-placeholder">Vælg en patient og en ordination</div>
            }
        </div>

    </div>

</div>


@code {
    private PatientResponse? patient;
    public Ordination? ordination;
    public List<Ordination> ordinationer = new List<Ordination>();
    private PatientResponse[]? patienter;

    protected override async Task OnInitializedAsync()
    {
        apiService.RefreshRequired += this.RefreshMe;
        patienter = await apiService.GetPatienter();
        await UpdateList();
    }

    private async Task UpdateList() {
        if (patient == null) return;
        Console.WriteLine("Updating list");
        
        OrdinationResponse? res = await apiService.GetOrdinationer();
        if (res == null) return;
        
        List<Ordination> pns = res.pn.ToList().Where(o => patient.ordinationer.Any(po => po == o.OrdinationId))
            .Cast<Ordination>().ToList();
        List<Ordination> dagligSkaev = res.dagligSkaev.ToList().Where(o => patient.ordinationer.Any(po => po == o.OrdinationId))
            .Cast<Ordination>().ToList();
        List<Ordination> dagligFast = res.dagligFast.ToList().Where(o => patient.ordinationer.Any(po => po == o.OrdinationId))
            .Cast<Ordination>().ToList();

        ordinationer.Clear();
        ordinationer.AddRange(pns);
        ordinationer.AddRange(dagligSkaev);
        ordinationer.AddRange(dagligFast);

        if (ordination != null) {
            ordination = ordinationer.Find(o => o.OrdinationId == ordination.OrdinationId);  
        }

        StateHasChanged();
    }
    
    private async void RefreshMe()
    {
        await UpdateList();
        Console.WriteLine("Refreshed VisOrdinationer");
        StateHasChanged();
    }

    private async void onSelectPatient(PatientResponse p) {
        this.patient = p;
        await UpdateList();
        Console.WriteLine("Selected " + p);
        StateHasChanged();
    }
    private async void onSelectOrdination(Ordination o) {
        this.ordination = o;
        await UpdateList();
        Console.WriteLine("Selected " + o);
        StateHasChanged();
    }
}